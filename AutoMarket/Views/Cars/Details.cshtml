@model AutoMarket.Models.Car
@using AutoMarket.Models
@using System.Linq

@{
    ViewData["Title"] = $"{Model.CarModel.Make.Name} {Model.CarModel.Name}";

    var mainImg =
        Model.Images?
            .OrderByDescending(i => i.IsMain)
            .ThenBy(i => i.SortOrder)
            .FirstOrDefault()?.Url
        ?? (string.IsNullOrWhiteSpace(Model.ImageUrl) ? "/img/no-car.jpg" : Model.ImageUrl);

    var gallery = (Model.Images ?? Enumerable.Empty<CarImage>())
        .OrderByDescending(i => i.IsMain)
        .ThenBy(i => i.SortOrder)
        .ToList();
}

<div class="pd-container">

    <!-- HEADER / TITLE -->
    <div class="pd-hero" style="margin-bottom:16px;">
        <h1 style="margin-bottom:6px;">@Model.CarModel.Make.Name @Model.CarModel.Name</h1>
        <p style="margin-bottom:0;">
            @Model.Year • @Model.MileageKm.ToString("N0") км • @Model.FuelType • @Model.Transmission
        </p>
    </div>

    <div class="pd-grid" style="align-items:start;">

        <!-- LEFT: GALLERY -->
        <div style="grid-column: span 7;">
            <div class="pd-surface" style="padding:14px;">
                <img id="mainCarImg"
                     src="@mainImg"
                     alt="Car image"
                     style="width:100%; height:420px; object-fit:cover; border-radius:16px; border:1px solid rgba(255,255,255,.10);" />

                @if (gallery.Count > 1)
                {
                    <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:12px;">
                        @foreach (var img in gallery)
                        {
                            <button type="button"
                                    class="pd-btn"
                                    style="padding:6px; border-radius:14px;"
                                    onclick="setMainImg('@img.Url')">
                                <img src="@img.Url"
                                     alt="thumb"
                                     style="width:84px; height:60px; object-fit:cover; border-radius:10px; border:1px solid rgba(255,255,255,.10);" />
                            </button>
                        }
                    </div>
                }
                else
                {
                    <div style="margin-top:10px; color:rgba(255,255,255,.6); font-size:14px;">
                        Няма добавени допълнителни снимки към тази обява.
                    </div>
                }
            </div>
        </div>

        <!-- RIGHT: PRICE + SPECS -->
        <div style="grid-column: span 5;">
            <div class="pd-surface" style="padding:16px; margin-bottom:16px;">
                <div style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
                    <div style="color:rgba(255,255,255,.7); font-size:14px;">Цена</div>
                    <div class="pd-price" style="margin:0;">@Model.Price.ToString("N0") лв.</div>
                </div>

                <div style="margin-top:14px; display:flex; gap:10px; flex-wrap:wrap;">
                    <span class="pd-badge">Година: <b style="color:rgba(255,255,255,.9)">@Model.Year</b></span>
                    <span class="pd-badge">Пробег: <b style="color:rgba(255,255,255,.9)">@Model.MileageKm.ToString("N0") км</b></span>
                    <span class="pd-badge">Гориво: <b style="color:rgba(255,255,255,.9)">@Model.FuelType</b></span>
                    <span class="pd-badge">Скорости: <b style="color:rgba(255,255,255,.9)">@Model.Transmission</b></span>
                    <span class="pd-badge">Двигател: <b style="color:rgba(255,255,255,.9)">@Model.EngineCapacityCc cc</b></span>
                    <span class="pd-badge">Мощност: <b style="color:rgba(255,255,255,.9)">@Model.HorsePower hp</b></span>
                </div>

                <div style="margin-top:14px; display:flex; gap:10px; flex-wrap:wrap;">
                    <a class="pd-btn pd-btn-primary" asp-controller="Cars" asp-action="Index">← Назад към обявите</a>

                    @if (User.IsInRole("Admin"))
                    {
                        <a class="pd-btn" asp-controller="Cars" asp-action="Edit" asp-route-id="@Model.Id">Редактирай</a>
                    }
                </div>
            </div>

            <!-- DESCRIPTION -->
            <div class="pd-surface" style="padding:16px;">
                <div style="font-weight:800; margin-bottom:8px;">Описание</div>

                @if (!string.IsNullOrWhiteSpace(Model.Description))
                {
                    <div style="color:rgba(255,255,255,.78); line-height:1.55;">
                        @Model.Description
                    </div>
                }
                else
                {
                    <div style="color:rgba(255,255,255,.6);">
                        Няма добавено описание.
                    </div>
                }

                @if (User.IsInRole("Admin"))
                {
                    <div style="margin-top:14px; display:flex; gap:10px; flex-wrap:wrap;">
                        <form asp-controller="Cars"
                              asp-action="Delete"
                              asp-route-id="@Model.Id"
                              method="post"
                              onsubmit="return confirm('Сигурна ли си, че искаш да изтриеш тази обява?');">
                            <button type="submit" class="pd-btn" style="border-color:rgba(255,80,80,.35);">
                                Изтрий
                            </button>
                        </form>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function setMainImg(url) {
            const img = document.getElementById('mainCarImg');
            if (!img) return;
            img.src = url;
        }
    </script>
}